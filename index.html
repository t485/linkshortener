<!DOCTYPE html>
<html>

<head>




<script src="https://www.gstatic.com/firebasejs/5.3.1/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyB-ly8ax35aWTAGhX2UDVuYxPSDlAU8kMk",
    authDomain: "t485-main.firebaseapp.com",
    databaseURL: "https://t485-main.firebaseio.com",
    projectId: "t485-main",
    storageBucket: "t485-main.appspot.com",
    messagingSenderId: "368513727602"
  };
  firebase.initializeApp(config);
</script>

    <script>
        /* global firebase */
        var name = window.location.hash.substring(1);

        if (name !== null && name !== "" && name !== undefined) {
            firebase.database().ref("/links/" + name + "/").once("value").then( function(data) {
                if (data.val() !== null) {
                    window.location.href = data.val();

                }
            });
        }
    </script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <title>Troop 485 Link Shortener</title>
</head>

<body>
    <div class="container">
        <div class="col-lg-12">
            <h1>Troop 485 Link Shortener</h1>
            <div id="create">
                <p>Create a redirection link below:</p>
                <div>

                    <label for="basic-url">Choose a short URL</label>
                    <div class="input-group">
                        <span class="input-group-addon" id="basic-addon3">https://ls.t485.org/</span>
                        <input aria-describedby="basic-addon3" class="form-control" id="url" placeholder="url" type="text">
                    </div><br>
                    <label for="link">Link to redirect to(include http:// or https:// )</label> <input class="form-control" id="link" placeholder="https://" type="text"><br>
                    <p class="text-danger text" id="error"></p>
                    <p class="text-success text" id="success">
                    </p><button class="form-control" id="submit" style="background-color:green;color:white;">Submit</button>
                </div>
            </div>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
            <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js">
            </script>
           
            <script>
                /* global firebase $ */
                function checkIfURLExists(id, link, callback) {
                    firebase.database().ref("/links/" + id + "/").once("value", function(data) {
                        var exists = (data.val() !== null);
                        callback(exists, id, link);
                    });
                }
                $(document).on('keyup', function(e) {
                    if (e.keyCode == 13) {
                        $("#submit").click();
                    }
                });

                $("#submit").click(function() {
                    var url = $("#url").val();
                    var link = $("#link").val();

                    var linkregex = new RegExp("(https?:|ftp:)\/\/.+", "g");
                    var urlregex = new RegExp("[A-Za-z0-9-_]", "g");

                    if (!linkregex.test(link)) {
                        $("#success").html("");
                        $("#error").html("The link to redirect to must be valid with http:// or https://");
                    }
                    else if (!urlregex.test(link)) {
                        $("#success").html("");
                        $("#error").html("the short url must only contain dashes(-), underscores(_), and alphanumeric charcters");
                    }
                    else {
                        checkIfURLExists(url, link, function(exists, id, link) {
                            if (exists) {
                                $("#success").html("");
                                $("#error").html("Your url already exists!");
                            }
                            else {
                                $("#link").val("");
                                $("#url").val("");
                                firebase.database().ref("/links/" + url + "/").set(link);
                                $("#success").html("Success! The link <b>https://ls.t485.org/" + url + "<\/b> now redirects to <b>" + link + "<\/b>. If you are embedding this link, use <b>http://ls.t485.org/#" + url + "<\/b>.");
                                url.val("");
                                link.val("");

                            }
                        });
                    }

                });
            </script>
        </div>
    </div>
</body>

</html>
